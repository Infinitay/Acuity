package com.acuitybotting.data.flow.messaging.services.aws.iot;

import com.acuitybotting.data.flow.messaging.services.aws.iot.domain.RegisterResponse;
import com.acuitybotting.data.flow.messaging.services.utils.HttpUtil;
import com.google.gson.Gson;
import lombok.extern.slf4j.Slf4j;

import java.util.Collections;
import java.util.HashMap;
import java.util.Map;
import java.util.Optional;

/**
 * Created by Zachary Herridge on 7/6/2018.
 */
@Slf4j
public class IotAuthenticationService {

    private static final String AUTH_URL = "https://7ja4dnkku1.execute-api.us-east-1.amazonaws.com/Prod/registerIotConnection";

    public static Optional<RegisterResponse> authenticate(String jwt){
        try {
            Gson gson = new Gson();

            Map<String, String> headers = new HashMap<>();
            headers.put("Accept", "application/json");
            headers.put("Content-Type", "application/json");

            String body = gson.toJson(Collections.singletonMap("token", jwt));
            String response = HttpUtil.makeRequest("POST", headers, AUTH_URL, null, body);
            RegisterResponse registerResponse = gson.fromJson(response, RegisterResponse.class);

            return Optional.ofNullable(registerResponse);
        } catch (Exception e) {
            log.error("Error authenticating iot.", e);
        }
        return Optional.empty();
    }

}
